'use client';

import { useState, useEffect, useRef } from 'react';
import { MessageCircle, X, Send, Bot, Sparkles, Phone, Mail, MapPin, Calendar, Shield, CreditCard } from 'lucide-react';

interface Message {
  id: number;
  text: string;
  sender: 'user' | 'ai';
  timestamp: Date;
  type?: 'booking' | 'city' | 'recommendation' | 'safety' | 'pricing' | 'menu' | 'history' | 'culture' | 'weather' | 'logistics';
}

interface SuperAIAssistantProps {
  language: 'fr' | 'ar' | 'en' | 'es';
}

export default function SuperAIAssistant({ language }: SuperAIAssistantProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState<Message[]>([]);
  const [inputText, setInputText] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const [userPreferences, setUserPreferences] = useState({
    interests: [] as string[],
    budget: '',
    duration: '',
    groupSize: 1,
    travelStyle: ''
  });
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // Base de connaissances compl√®te du Maroc
  type IntentType = 'booking' | 'city' | 'recommendation' | 'safety' | 'pricing' | 'menu' | 'history' | 'culture' | 'weather' | 'logistics';
  interface IntentResponse { text: string; type: IntentType; }

  // --- Helpers to localize dynamic blocks for EN/ES so they don't fall back to FR ---
  const cityInfoEn = (city: string) => {
    switch (city) {
      case 'marrakech':
        return `üèõÔ∏è **Marrakech - The Red City**

üìö **History:** Founded in 1062 by the Almoravids. UNESCO-listed medina with centuries-old architecture.

üéØ **Highlights:**
‚Ä¢ Jemaa el-Fna square ‚Äì heart of the medina
‚Ä¢ Koutoubia ‚Äì 12th-century minaret
‚Ä¢ Majorelle Gardens ‚Äì iconic oasis
‚Ä¢ Bahia Palace ‚Äì masterpiece of Moroccan art
‚Ä¢ Souks ‚Äì labyrinth of artisans

üõ°Ô∏è **Safety:** Very safe in tourist areas. Avoid deserted alleys late at night.

üå§Ô∏è **Best time:** October‚ÄìApril (20‚Äì25¬∞C). Avoid July‚ÄìAugust (40¬∞C+)

üçΩÔ∏è **Specialties:** Tagine, couscous, almond pastries, mint tea`;
      case 'fes':
        return `üèõÔ∏è **Fez - Spiritual Capital**

üìö **History:** Founded in 789. Home to Al‚ÄëQarawiyyin (859), the world‚Äôs oldest university.

üéØ **Highlights:**
‚Ä¢ Fes el‚ÄëBali medina ‚Äì world‚Äôs largest car‚Äëfree area
‚Ä¢ Al‚ÄëQarawiyyin University
‚Ä¢ Chouara Tanneries
‚Ä¢ Bou Inania Madrasa
‚Ä¢ Royal Palace gates

üõ°Ô∏è **Safety:** Safe; the medina is very maze‚Äëlike‚Äîuse a guide.

üå§Ô∏è **Best time:** Mar‚ÄìMay, Sep‚ÄìNov (15‚Äì25¬∞C)`;
      case 'chefchaouen':
        return `üèõÔ∏è **Chefchaouen - The Blue Pearl**

üéØ **Highlights:**
‚Ä¢ Blue-painted medina
‚Ä¢ Kasbah & Uta el‚ÄëHammam square
‚Ä¢ Spanish Mosque viewpoint
‚Ä¢ Akchour waterfalls

üõ°Ô∏è **Safety:** Very safe; take care on mountain trails.

üå§Ô∏è **Best time:** Apr‚ÄìJun, Sep‚ÄìOct`;
      case 'casablanca':
        return `üèõÔ∏è **Casablanca - Economic Capital**

üéØ **Highlights:**
‚Ä¢ Hassan II Mosque
‚Ä¢ Ain Diab Corniche
‚Ä¢ Habous quarter
‚Ä¢ Art Deco architecture

üõ°Ô∏è **Safety:** Safe in tourist zones; avoid some outskirts at night.`;
      case 'essaouira':
        return `üèõÔ∏è **Essaouira - Wind City**

üéØ **Highlights:**
‚Ä¢ Fortified medina & ramparts
‚Ä¢ Fishing port & blue boats
‚Ä¢ Atlantic beaches & surf

üõ°Ô∏è **Safety:** Very safe; strong winds‚Äîbring a light jacket.`;
      default:
        return "City not found.";
    }
  };

  const cityInfoEs = (city: string) => {
    switch (city) {
      case 'marrakech':
        return `üèõÔ∏è **Marrakech - La Ciudad Roja**

üìö **Historia:** Fundada en 1062 por los almoh√°ravides. Medina declarada Patrimonio UNESCO.

üéØ **Imprescindibles:**
‚Ä¢ Plaza Jemaa el‚ÄëFna ‚Äì coraz√≥n de la medina
‚Ä¢ Koutoubia ‚Äì alminar del s. XII
‚Ä¢ Jardines Majorelle ‚Äì oasis ic√≥nico
‚Ä¢ Palacio de la Bah√≠a ‚Äì obra maestra del arte marroqu√≠
‚Ä¢ Zocos ‚Äì laberinto de artesanos

üõ°Ô∏è **Seguridad:** Muy segura en zonas tur√≠sticas. Evitar callejones solitarios de noche.

üå§Ô∏è **Mejor √©poca:** Octubre‚Äìabril (20‚Äì25¬∞C); evitar julio‚Äìagosto (40¬∞C+)

üçΩÔ∏è **Especialidades:** Taj√≠n, cusc√∫s, dulces de almendra, t√© de menta`;
      case 'fes':
        return `üèõÔ∏è **Fez - Capital Espiritual**

üìö **Historia:** Fundada en 789. Sede de Al‚ÄëQarawiyyin (859), la universidad m√°s antigua del mundo.

üéØ **Imprescindibles:**
‚Ä¢ Medina Fes el‚ÄëBali ‚Äì mayor zona peatonal del mundo
‚Ä¢ Universidad Al‚ÄëQarawiyyin
‚Ä¢ Curtidur√≠as Chouara
‚Ä¢ Madraza Bou Inania
‚Ä¢ Puertas del Palacio Real

üõ°Ô∏è **Seguridad:** Segura; la medina es laber√≠ntica‚Äîusa gu√≠a.

üå§Ô∏è **Mejor √©poca:** Mar‚Äìmay, sep‚Äìnov (15‚Äì25¬∞C)`;
      case 'chefchaouen':
        return `üèõÔ∏è **Chefchaouen - La Perla Azul**

üéØ **Imprescindibles:**
‚Ä¢ Medina azul
‚Ä¢ Kasbah y plaza Uta el‚ÄëHammam
‚Ä¢ Mezquita espa√±ola (mirador)
‚Ä¢ Cascadas de Akchour

üõ°Ô∏è **Seguridad:** Muy segura; precauci√≥n en senderos de monta√±a.`;
      case 'casablanca':
        return `üèõÔ∏è **Casablanca - Capital Econ√≥mica**

üéØ **Imprescindibles:**
‚Ä¢ Mezquita Hassan II
‚Ä¢ Corniche Ain Diab
‚Ä¢ Barrio Habous
‚Ä¢ Arquitectura Art D√©co

üõ°Ô∏è **Seguridad:** Segura en zonas tur√≠sticas; evitar algunos barrios perif√©ricos de noche.`;
      case 'essaouira':
        return `üèõÔ∏è **Essaouira - Ciudad del Viento**

üéØ **Imprescindibles:**
‚Ä¢ Medina amurallada y baluartes
‚Ä¢ Puerto pesquero y barcas azules
‚Ä¢ Playas del Atl√°ntico y surf

üõ°Ô∏è **Seguridad:** Muy segura; vientos fuertes‚Äîlleva chaqueta.`;
      default:
        return "Ciudad no encontrada.";
    }
  };

  const weatherEn = (city: string) => `‚òÄÔ∏è Typical weather in ${city}

‚Ä¢ Spring: 20‚Äì28¬∞C, ideal for visits
‚Ä¢ Summer: hot (Marrakech up to 35‚Äì42¬∞C) ‚Äì activities morning/evening
‚Ä¢ Autumn: 22‚Äì30¬∞C, great conditions
‚Ä¢ Winter: 12‚Äì20¬∞C, cooler in the Atlas`;

  const weatherEs = (city: string) => `‚òÄÔ∏è Clima t√≠pico en ${city}

‚Ä¢ Primavera: 20‚Äì28¬∞C, ideal para visitas
‚Ä¢ Verano: caluroso (Marrakech hasta 35‚Äì42¬∞C) ‚Äì actividades ma√±ana/tarde
‚Ä¢ Oto√±o: 22‚Äì30¬∞C, condiciones excelentes
‚Ä¢ Invierno: 12‚Äì20¬∞C, m√°s fresco en el Atlas`;

  const moroccoKnowledge = {
    fr: {
      cities: {
        marrakech: {
          name: "Marrakech",
          nickname: "La Ville Rouge",
          history: "Fond√©e en 1062 par les Almoravides, Marrakech fut la capitale de plusieurs dynasties. Son nom vient de 'Mur Akush' (Terre de Dieu). La m√©dina, class√©e UNESCO, abrite des tr√©sors architecturaux mill√©naires.",
          attractions: [
            "Place Jemaa el-Fna - C≈ìur battant de la m√©dina",
            "Koutoubia - Minaret embl√©matique du 12√®me si√®cle", 
            "Jardins Majorelle - Oasis de Yves Saint Laurent",
            "Palais Bahia - Chef-d'≈ìuvre de l'art marocain",
            "Souks - Labyrinthe de 40 000 artisans"
          ],
          excursions: [
            "Vall√©e de l'Ourika (1j) - 35‚Ç¨ - Cascades et villages berb√®res",
            "Essaouira (1j) - 45‚Ç¨ - Cit√© portugaise et plages",
            "D√©sert d'Agafay (1j) - 65‚Ç¨ - Sahara proche avec dromadaires",
            "Atlas et Imlil (1j) - 55‚Ç¨ - Plus haut sommet d'Afrique du Nord",
            "A√Øt Benhaddou (1j) - 50‚Ç¨ - Kasbah de Game of Thrones"
          ],
          safety: "Zone tr√®s s√ªre. √âviter les ruelles isol√©es la nuit. Attention aux faux guides pr√®s de Jemaa el-Fna.",
          bestTime: "Octobre-Avril (20-25¬∞C). √âviter Juillet-Ao√ªt (40¬∞C+)",
          specialties: "Tajine, couscous, p√¢tisseries aux amandes, th√© √† la menthe"
        },
        fes: {
          name: "F√®s",
          nickname: "Capitale Spirituelle",
          history: "Fond√©e en 789, F√®s abrite la plus ancienne universit√© du monde (Al Quaraouiyine, 859). Centre intellectuel de l'Islam pendant des si√®cles, ses artisans perp√©tuent des techniques mill√©naires.",
          attractions: [
            "M√©dina de F√®s el-Bali - Plus grande m√©dina pi√©tonne au monde",
            "Universit√© Al Quaraouiyine - Plus ancienne universit√© (859)",
            "Tanneries Chouara - Cuir traditionnel depuis le 11√®me si√®cle",
            "Medersa Bou Inania - Joyau de l'architecture m√©rinide",
            "Palais Royal - Portes dor√©es monumentales"
          ],
          excursions: [
            "Mekn√®s et Volubilis (1j) - 40‚Ç¨ - Cit√© imp√©riale et ruines romaines",
            "Chefchaouen (1j) - 60‚Ç¨ - Perle bleue du Rif",
            "Ifrane et C√®dres (1j) - 45‚Ç¨ - Suisse marocaine",
            "Sefrou (1/2j) - 25‚Ç¨ - Ville des cerises"
          ],
          safety: "Tr√®s s√ªre. Se munir d'un guide dans la m√©dina (tr√®s labyrinthique). √âviter les tanneries en √©t√© (odeurs).",
          bestTime: "Mars-Mai, Septembre-Novembre (15-25¬∞C)",
          specialties: "Pastilla au pigeon, fassi (rago√ªt), cornes de gazelle"
        },
        chefchaouen: {
          name: "Chefchaouen",
          nickname: "La Perle Bleue",
          history: "Fond√©e en 1471 comme forteresse contre les Portugais. Les maisons bleues symbolisent le ciel et rappellent l'h√©ritage andalou des r√©fugi√©s de Grenade.",
          attractions: [
            "M√©dina bleue - Ruelles photog√©niques uniques au monde",
            "Kasbah - Forteresse du 15√®me si√®cle",
            "Place Uta el-Hammam - C≈ìur social de la ville",
            "Mosqu√©e espagnole - Vue panoramique",
            "Cascades d'Akchour - Piscines naturelles (45min)"
          ],
          excursions: [
            "Parc National Talassemtane (1j) - 35‚Ç¨ - Randonn√©e et c√®dres",
            "Akchour et Pont de Dieu (1j) - 40‚Ç¨ - Cascades spectaculaires",
            "T√©touan (1/2j) - 30‚Ç¨ - M√©dina andalouse"
          ],
          safety: "Tr√®s s√ªre, population accueillante. Attention aux sentiers de montagne (guide recommand√©).",
          bestTime: "Avril-Juin, Septembre-Octobre (18-28¬∞C)",
          specialties: "Fromage de ch√®vre local, miel de montagne, tajine aux olives"
        },
        casablanca: {
          name: "Casablanca",
          nickname: "Capitale √âconomique",
          history: "Ancien port berb√®re Anfa, rebaptis√©e par les Portugais. D√©velopp√©e sous le Protectorat fran√ßais, elle devient la m√©tropole √©conomique moderne du Maroc.",
          attractions: [
            "Mosqu√©e Hassan II - 3√®me plus grande mosqu√©e au monde",
            "Corniche Ain Diab - Front de mer moderne",
            "Quartier Habous - Nouvelle m√©dina ann√©es 1930",
            "Villa des Arts - Centre culturel contemporain",
            "March√© Central - Architecture Art D√©co"
          ],
          excursions: [
            "Rabat (1j) - 35‚Ç¨ - Capitale administrative",
            "El Jadida (1j) - 40‚Ç¨ - Cit√© portugaise fortifi√©e",
            "Azemmour (1/2j) - 25‚Ç¨ - Village d'artistes"
          ],
          safety: "S√ªre dans les zones touristiques. √âviter certains quartiers p√©riph√©riques la nuit.",
          bestTime: "Toute l'ann√©e (climat oc√©anique temp√©r√©)",
          specialties: "Poissons grill√©s, pastilla au lait, mahalabia"
        },
        essaouira: {
          name: "Essaouira",
          nickname: "Cit√© des Vents",
          history: "Ancienne Mogador, port fortifi√© par les Portugais au 16√®me si√®cle. Redessin√©e par l'architecte fran√ßais Th√©odore Cornut au 18√®me si√®cle. Carrefour commercial historique.",
          attractions: [
            "M√©dina fortifi√©e - Architecture militaire portugaise",
            "Port de p√™che - Barques bleues traditionnelles",
            "Remparts et canons - Vues oc√©aniques",
            "√éle de Mogador - R√©serve ornithologique",
            "Plage - Kitesurf et sports nautiques"
          ],
          excursions: [
            "√éles Purpuraires (1/2j) - 30‚Ç¨ - Observation oiseaux",
            "For√™t d'arganiers (1/2j) - 25‚Ç¨ - Huile d'argan authentique",
            "Safi (1j) - 35‚Ç¨ - Capitale de la poterie"
          ],
          safety: "Tr√®s s√ªre, ambiance d√©tendue. Attention aux vents forts (emporter veste).",
          bestTime: "Avril-Octobre (20-26¬∞C), vents rafra√Æchissants",
          specialties: "Poissons grill√©s, tajine aux fruits de mer, huile d'argan"
        }
      },
      
      bookingFlow: {
        steps: [
          "S√©lection destination et dates",
          "Choix du type d'h√©bergement", 
          "Options transport et guides",
          "Activit√©s et excursions",
          "R√©capitulatif et paiement"
        ],
        prices: {
          "circuit-imperial": { base: 450, luxury: 850 },
          "sahara-express": { base: 280, luxury: 480 },
          "atlas-discovery": { base: 320, luxury: 520 },
          "coastal-tour": { base: 380, luxury: 680 }
        }
      },

      responses: {
        welcome: "Salut ! Je suis Aicha, votre guide IA ultra-intelligente du Maroc ! üá≤üá¶‚ú® Je connais TOUT sur notre magnifique pays : histoire, culture, excursions, s√©curit√©, r√©servations... Dites-moi ce qui vous passionne !",
        
        cityInfo: (city: string) => {
          const info = moroccoKnowledge.fr.cities[city as keyof typeof moroccoKnowledge.fr.cities];
          if (!info) return "D√©sol√©e, je ne connais pas cette ville. Essayez Marrakech, F√®s, Chefchaouen, Casablanca ou Essaouira.";
          
          return `üèõÔ∏è **${info.name} - ${info.nickname}**\n\nüìö **Histoire :** ${info.history}\n\nüéØ **Incontournables :**\n${info.attractions.map(a => `‚Ä¢ ${a}`).join('\n')}\n\nüöó **Excursions populaires :**\n${info.excursions.map(e => `‚Ä¢ ${e}`).join('\n')}\n\nüõ°Ô∏è **S√©curit√© :** ${info.safety}\n\nüå§Ô∏è **Meilleure p√©riode :** ${info.bestTime}\n\nüçΩÔ∏è **Sp√©cialit√©s :** ${info.specialties}`;
        },

        bookingStart: "Parfait ! Cr√©ons votre voyage de r√™ve ! üéØ\n\n**√âtape 1/5 : Destination et dates**\n\nQuelle ville vous attire le plus ?\n‚Ä¢ üî¥ Marrakech (Ville Rouge)\n‚Ä¢ üé® F√®s (Capitale Spirituelle) \n‚Ä¢ üíô Chefchaouen (Perle Bleue)\n‚Ä¢ üåä Essaouira (Cit√© des Vents)\n‚Ä¢ üè¢ Casablanca (M√©tropole)\n\nEt quelles sont vos dates pr√©f√©r√©es ?",

        recommendations: (interests: string[]) => {
          const recs = [];
          if (interests.includes('histoire')) recs.push("üèõÔ∏è **F√®s** - M√©dina mill√©naire et universit√© Al Quaraouiyine");
          if (interests.includes('nature')) recs.push("üèîÔ∏è **Atlas** - Randonn√©es et villages berb√®res authentiques");
          if (interests.includes('plage')) recs.push("üåä **Essaouira** - Kitesurf et fruits de mer frais");
          if (interests.includes('photo')) recs.push("üì∏ **Chefchaouen** - Ruelles bleues Instagram-parfaites");
          if (interests.includes('aventure')) recs.push("üê™ **Sahara** - Nuit sous les √©toiles en camp berb√®re");
          
          return `Bas√© sur vos go√ªts, voici mes recommandations VIP :\n\n${recs.join('\n\n')}\n\nVoulez-vous que je vous pr√©pare un itin√©raire personnalis√© ?`;
        },

        logistics: "üöê Transport au Maroc\n\n‚Ä¢ V√©hicules climatis√©s r√©cents\n‚Ä¢ Chauffeurs pros et assur√©s\n‚Ä¢ Trains ONCF fiables entre grandes villes\n‚Ä¢ vols internes possibles (RAM)\n\nBesoin d'un transfert a√©roport/h√¥tel ?",

        culture: "üé≠ Culture marocaine\n\n‚Ä¢ Hospitalit√© l√©gendaire\n‚Ä¢ Artisanat (zellige, bois, cuir, tapis)\n‚Ä¢ Musique (gnaoua, andalouse)\n‚Ä¢ Gastronomie (tajine, pastilla, th√© √† la menthe)\n\nSouhaitez-vous une exp√©rience culinaire ou atelier artisanal ?",

        weather: (city: string) => `‚òÄÔ∏è M√©t√©o typique √† ${city} (saisons)\n\n‚Ä¢ Printemps: 20-28¬∞C parfait pour visites\n‚Ä¢ √ât√©: chaud (Marrakech 35-42¬∞C) ‚Äî activit√©s matin/soir\n‚Ä¢ Automne: 22-30¬∞C id√©al\n‚Ä¢ Hiver: 12-20¬∞C doux (plus frais √† l'Atlas)`,

        fallback: "Je suis votre experte Maroc. Posez-moi une question pr√©cise (ex: 'Infos Marrakech', 'S√©curit√©', 'Prix Sahara', 'R√©server 4 jours')."
      }
    },

    ar: {
      responses: {
        welcome: "ŸÖÿ±ÿ≠ÿ®ÿßŸã! ÿ£ŸÜÿß ÿπÿßÿ¶ÿ¥ÿ©ÿå ÿßŸÑŸÖÿ±ÿ¥ÿØ ÿßŸÑÿ∞ŸÉŸä ŸÑŸÑŸÖÿ∫ÿ±ÿ® üá≤üá¶‚ú® ÿ£ÿπÿ±ŸÅ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑÿ´ŸÇÿßŸÅÿ© ŸàÿßŸÑÿ£ÿ≥ÿπÿßÿ± ŸàÿßŸÑÿ£ŸÖÿßŸÜ ŸàÿßŸÑÿ≠ÿ¨Ÿàÿ≤ÿßÿ™. ÿ®ŸÖÿßÿ∞ÿß ÿ£ÿ≥ÿßÿπÿØŸÉÿü",
        bookingStart: "ŸÖŸÖÿ™ÿßÿ≤! ŸÑŸÜŸÜÿ¥ÿ¶ ÿ±ÿ≠ŸÑÿ™ŸÉ! üéØ\n\nÿßŸÑÿÆÿ∑Ÿàÿ© 1/5: ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿØŸäŸÜÿ© ŸàÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ. ŸÖÿß ŸáŸä ÿßŸÑŸÖÿØŸäŸÜÿ© ÿßŸÑÿ™Ÿä ÿ™ŸÅÿ∂ŸÑŸáÿßÿü ŸÖÿ±ÿßŸÉÿ¥ / ŸÅÿßÿ≥ / ÿ¥ŸÅÿ¥ÿßŸàŸÜ / ÿßŸÑÿµŸàŸäÿ±ÿ© / ÿßŸÑÿØÿßÿ± ÿßŸÑÿ®Ÿäÿ∂ÿßÿ°",
        // ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸÜŸÅÿ≥ ŸÖŸÜÿ∑ŸÇ ÿßŸÑŸÅÿ±ŸÜÿ≥Ÿäÿ© ŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿØŸÜ ŸàÿßŸÑÿ™ŸàÿµŸäÿßÿ™ ŸÖÿ§ŸÇÿ™ÿßŸã
        cityInfo: (city: string) => moroccoKnowledge.fr.responses.cityInfo(city),
        recommendations: (interests: string[]) => moroccoKnowledge.fr.responses.recommendations(interests),
        logistics: "üöê ÿßŸÑŸÜŸÇŸÑ ŸÅŸä ÿßŸÑŸÖÿ∫ÿ±ÿ® ŸÖŸàÿ´ŸàŸÇ Ÿàÿ¢ŸÖŸÜ: ÿ≥Ÿäÿßÿ±ÿßÿ™ ŸÖŸÉŸäŸÅÿ© Ÿàÿ≥ÿßÿ¶ŸÇŸàŸÜ ŸÖÿ≠ÿ™ÿ±ŸÅŸàŸÜ ŸàŸÇÿ∑ÿßÿ±ÿßÿ™ ÿ®ŸäŸÜ ÿßŸÑŸÖÿØŸÜ.",
        culture: "üé≠ ÿßŸÑÿ´ŸÇÿßŸÅÿ© ÿßŸÑŸÖÿ∫ÿ±ÿ®Ÿäÿ©: ÿ∂ŸäÿßŸÅÿ©ÿå ÿ≠ÿ±ŸÅ ŸäÿØŸàŸäÿ©ÿå ŸÖŸàÿ≥ŸäŸÇŸâ ⁄≠ŸÜÿßŸàÿ©ÿå ŸàŸÖÿ£ŸÉŸàŸÑÿßÿ™ ŸÑÿ∞Ÿäÿ∞ÿ©.",
        weather: (city: string) => moroccoKnowledge.fr.responses.weather(city),
        fallback: "ÿßÿ≥ÿ£ŸÑŸÜŸä ÿ≥ÿ§ÿßŸÑÿßŸã ŸÖÿ≠ÿØÿØÿßŸã: ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖÿ±ÿßŸÉÿ¥ÿå ÿßŸÑÿ£ŸÖÿßŸÜÿå ÿ£ÿ≥ÿπÿßÿ± ÿßŸÑÿµÿ≠ÿ±ÿßÿ°ÿå ÿ≠ÿ¨ÿ≤ 4 ÿ£ŸäÿßŸÖ..."
      }
    },

    en: {
      responses: {
        welcome: "Hi! I'm Aicha, your AI Morocco guide üá≤üá¶‚ú® I know everything about history, culture, excursions, safety, prices and bookings. What can I help you with?",
        bookingStart: "Great! Let's build your trip! üéØ\n\nStep 1/5: Choose city and dates. Which city do you prefer? Marrakech / Fez / Chefchaouen / Essaouira / Casablanca",
        cityInfo: (city: string) => cityInfoEn(city),
        recommendations: (interests: string[]) => moroccoKnowledge.fr.responses.recommendations(interests),
        logistics: "üöê Transport in Morocco is reliable and safe: air‚Äëconditioned vehicles, professional drivers, and intercity trains.",
        culture: "üé≠ Moroccan culture: hospitality, crafts, Gnawa music, and delicious cuisine.",
        weather: (city: string) => weatherEn(city),
        fallback: "Ask me something specific: Marrakech info, safety, Sahara prices, book 4 days..."
      }
    },

    es: {
      responses: {
        welcome: "¬°Hola! Soy Aicha, tu gu√≠a IA de Marruecos üá≤üá¶‚ú® Conozco historia, cultura, excursiones, seguridad, precios y reservas. ¬øEn qu√© te ayudo?",
        bookingStart: "¬°Perfecto! ¬°Construyamos tu viaje! üéØ\n\nPaso 1/5: Elige ciudad y fechas. ¬øQu√© ciudad prefieres? Marrakech / Fez / Chefchaouen / Essaouira / Casablanca",
        cityInfo: (city: string) => cityInfoEs(city),
        recommendations: (interests: string[]) => moroccoKnowledge.fr.responses.recommendations(interests),
        logistics: "üöê El transporte en Marruecos es fiable y seguro: veh√≠culos con aire acondicionado, conductores profesionales y trenes entre ciudades.",
        culture: "üé≠ Cultura marroqu√≠: hospitalidad, artesan√≠a, m√∫sica Gnawa y gastronom√≠a deliciosa.",
        weather: (city: string) => weatherEs(city),
        fallback: "Hazme una pregunta concreta: Info de Marrakech, seguridad, precios del S√°hara, reservar 4 d√≠as..."
      }
    }
  };

  const currentContent = moroccoKnowledge[language];

  // When opening the chat, always show a fresh welcome in the current language
  useEffect(() => {
    if (isOpen) {
      setMessages([]);
      setTimeout(() => {
        addAIMessage(currentContent.responses.welcome);
      }, 400);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isOpen, language]);

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  const addAIMessage = (text: string, type: IntentType = 'recommendation') => {
    setIsTyping(true);
    setTimeout(() => {
      setMessages(prev => [...prev, {
        id: Date.now(),
        text,
        sender: 'ai',
        timestamp: new Date(),
        type
      }]);
      setIsTyping(false);
    }, 2000);
  };

  const addUserMessage = (text: string) => {
    setMessages(prev => [...prev, {
      id: Date.now(),
      text,
      sender: 'user',
      timestamp: new Date()
    }]);

    setTimeout(() => {
      const response = generateIntelligentResponse(text.toLowerCase());
      addAIMessage(response.text, response.type);
    }, 800);
  };

  const generateIntelligentResponse = (userInput: string): IntentResponse => {
    // D√©tection d'intention avanc√©e
    if (userInput.includes('r√©serv') || userInput.includes('book') || userInput.includes('voyage')) {
      return {
        text: currentContent.responses.bookingStart,
        type: 'booking'
      };
    }

    // Informations sur les villes
    const cities = ['marrakech', 'f√®s', 'fes', 'chefchaouen', 'casablanca', 'essaouira'];
    const mentionedCity = cities.find(city => userInput.includes(city));
    if (mentionedCity) {
      return {
        text: currentContent.responses.cityInfo
          ? currentContent.responses.cityInfo(mentionedCity === 'fes' ? 'fes' : mentionedCity)
          : moroccoKnowledge.fr.responses.cityInfo(mentionedCity === 'fes' ? 'fes' : mentionedCity),
        type: 'city'
      };
    }

    // D√©tection d'int√©r√™ts pour recommandations
    const interests: string[] = [];
    if (userInput.includes('histoire') || userInput.includes('culture')) interests.push('histoire');
    if (userInput.includes('nature') || userInput.includes('montagne')) interests.push('nature');
    if (userInput.includes('plage') || userInput.includes('mer')) interests.push('plage');
    if (userInput.includes('photo') || userInput.includes('instagram')) interests.push('photo');
    if (userInput.includes('aventure') || userInput.includes('sahara')) interests.push('aventure');

    if (interests.length > 0) {
      setUserPreferences(prev => ({ ...prev, interests }));
      return {
        text: currentContent.responses.recommendations
          ? currentContent.responses.recommendations(interests)
          : moroccoKnowledge.fr.responses.recommendations(interests),
        type: 'recommendation'
      };
    }

    // S√©curit√© / Safety
    if (userInput.includes('s√©cur') || userInput.includes('danger') || userInput.includes('s√ªr') || userInput.includes('safety')) {
      const safetyText = language === 'fr'
        ? "üõ°Ô∏è **S√©curit√© au Maroc - Guide Complet**\n\n‚úÖ **Zones tr√®s s√ªres :** Villes touristiques principales\n‚ö†Ô∏è **Pr√©cautions :** √âviter ruelles isol√©es la nuit\nüö´ **√Ä √©viter :** Quelques quartiers p√©riph√©riques\n\n**Conseils :**\n‚Ä¢ Copies de papiers\n‚Ä¢ N√©gocier avant service\n‚Ä¢ Taxis officiels\n‚Ä¢ Respect des codes locaux"
        : language === 'ar'
          ? "üõ°Ô∏è **ÿßŸÑÿ£ŸÖÿßŸÜ ŸÅŸä ÿßŸÑŸÖÿ∫ÿ±ÿ® - ÿØŸÑŸäŸÑ ŸÖÿÆÿ™ÿµÿ±**\n\n‚úÖ **ŸÖŸÜÿßÿ∑ŸÇ ÿ¢ŸÖŸÜÿ© ÿ¨ÿØÿßŸã:** ÿßŸÑŸÖÿØŸÜ ÿßŸÑÿ≥Ÿäÿßÿ≠Ÿäÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©\n‚ö†Ô∏è **ÿßÿ≠ÿ™Ÿäÿßÿ∑ÿßÿ™:** ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ£ÿ≤ŸÇÿ© ÿßŸÑŸÖÿπÿ≤ŸàŸÑÿ© ŸÑŸäŸÑÿßŸã\nüö´ **ÿ™ÿ¨ŸÜÿ®:** ÿ®ÿπÿ∂ ÿßŸÑÿ£ÿ≠Ÿäÿßÿ° ÿßŸÑÿ∑ÿ±ŸÅŸäÿ©\n\n**ŸÜÿµÿßÿ¶ÿ≠:**\n‚Ä¢ ŸÜÿ≥ÿÆ ŸÖŸÜ ÿßŸÑŸàÿ´ÿßÿ¶ŸÇ\n‚Ä¢ ÿßŸÑÿ™ŸÅÿßŸàÿ∂ ŸÇÿ®ŸÑ ÿßŸÑÿÆÿØŸÖÿ©\n‚Ä¢ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ≥Ÿäÿßÿ±ÿßÿ™ ÿßŸÑÿ£ÿ¨ÿ±ÿ© ÿßŸÑÿ±ÿ≥ŸÖŸäÿ©\n‚Ä¢ ÿßÿ≠ÿ™ÿ±ÿßŸÖ ÿßŸÑÿπÿßÿØÿßÿ™"
          : language === 'en'
            ? "üõ°Ô∏è **Safety in Morocco - Quick Guide**\n\n‚úÖ **Very safe areas:** Main tourist cities\n‚ö†Ô∏è **Precautions:** Avoid deserted alleys at night\nüö´ **Avoid:** Some outer districts\n\n**Tips:**\n‚Ä¢ Carry copies of documents\n‚Ä¢ Agree price before service\n‚Ä¢ Use official taxis\n‚Ä¢ Respect local codes"
            : "üõ°Ô∏è **Seguridad en Marruecos - Gu√≠a R√°pida**\n\n‚úÖ **Zonas muy seguras:** Ciudades tur√≠sticas principales\n‚ö†Ô∏è **Precauciones:** Evitar callejones solitarios de noche\nüö´ **Evitar:** Algunos barrios perif√©ricos\n\n**Consejos:**\n‚Ä¢ Copias de documentos\n‚Ä¢ Acordar precio antes del servicio\n‚Ä¢ Taxis oficiales\n‚Ä¢ Respetar c√≥digos locales";
      return { text: safetyText, type: 'safety' };
    }

    // M√©t√©o / climat
    if (userInput.includes('m√©t√©o') || userInput.includes('climat') || userInput.includes('weather')) {
      const city = cities.find(c => userInput.includes(c)) || 'Marrakech';
      return {
        text: currentContent.responses.weather
          ? currentContent.responses.weather(city)
          : moroccoKnowledge.fr.responses.weather(city),
        type: 'history'
      };
    }

    // Culture / gastronomie
    if (userInput.includes('culture') || userInput.includes('gastr') || userInput.includes('cuisine')) {
      return { text: currentContent.responses.culture, type: 'culture' } as IntentResponse;
    }

    // Logistique / transport
    if (userInput.includes('transport') || userInput.includes('taxi') || userInput.includes('train')) {
      return { text: currentContent.responses.logistics, type: 'logistics' } as IntentResponse;
    }

    // Prix / Prices / Precios
    if (userInput.includes('prix') || userInput.includes('co√ªt') || userInput.includes('budget') || userInput.includes('price') || userInput.includes('prices')) {
      const pricingText = language === 'fr'
        ? "üí∞ **Tarifs 2024 - Circuits Premium**\n\nüèõÔ∏è **Circuit Imp√©rial** (7j)\n‚Ä¢ Standard : 450‚Ç¨ ‚Ä¢ Luxe : 850‚Ç¨\n\nüèúÔ∏è **Sahara Express** (4j)\n‚Ä¢ Standard : 280‚Ç¨ ‚Ä¢ Luxe : 480‚Ç¨\n\nüèîÔ∏è **Atlas D√©couverte** (5j)\n‚Ä¢ Standard : 320‚Ç¨ ‚Ä¢ Luxe : 520‚Ç¨\n\nüåä **Tour C√¥tier** (6j)\n‚Ä¢ Standard : 380‚Ç¨ ‚Ä¢ Luxe : 680‚Ç¨\n\n*Inclus : h√©bergement, transport, guides, repas*"
        : language === 'ar'
          ? "üí∞ **ÿßŸÑÿ£ÿ≥ÿπÿßÿ± 2024 - ÿ¨ŸàŸÑÿßÿ™ ŸÖŸÖŸäÿ≤ÿ©**\n\nüèõÔ∏è **ÿßŸÑÿ¨ŸàŸÑÿ© ÿßŸÑÿ•ŸÖÿ®ÿ±ÿßÿ∑Ÿàÿ±Ÿäÿ©** (7 ÿ£ŸäÿßŸÖ)\n‚Ä¢ ÿπÿßÿØŸä: 450‚Ç¨ ‚Ä¢ ŸÅÿßÿÆÿ±: 850‚Ç¨\n\nüèúÔ∏è **ÿßŸÑÿµÿ≠ÿ±ÿßÿ° ÿßŸÑÿ≥ÿ±Ÿäÿπÿ©** (4 ÿ£ŸäÿßŸÖ)\n‚Ä¢ ÿπÿßÿØŸä: 280‚Ç¨ ‚Ä¢ ŸÅÿßÿÆÿ±: 480‚Ç¨\n\nüèîÔ∏è **ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿßŸÑÿ£ÿ∑ŸÑÿ≥** (5 ÿ£ŸäÿßŸÖ)\n‚Ä¢ ÿπÿßÿØŸä: 320‚Ç¨ ‚Ä¢ ŸÅÿßÿÆÿ±: 520‚Ç¨\n\nüåä **ÿ¨ŸàŸÑÿ© ÿßŸÑÿ≥ÿßÿ≠ŸÑ** (6 ÿ£ŸäÿßŸÖ)\n‚Ä¢ ÿπÿßÿØŸä: 380‚Ç¨ ‚Ä¢ ŸÅÿßÿÆÿ±: 680‚Ç¨\n\n*Ÿäÿ¥ŸÖŸÑ: ÿßŸÑÿ•ŸÇÿßŸÖÿ©ÿå ÿßŸÑŸÜŸÇŸÑÿå ÿßŸÑŸÖÿ±ÿ¥ÿØŸàŸÜÿå ÿßŸÑŸàÿ¨ÿ®ÿßÿ™*"
          : language === 'en'
            ? "üí∞ **2024 Pricing - Premium Tours**\n\nüèõÔ∏è **Imperial Circuit** (7d)\n‚Ä¢ Standard: 450‚Ç¨ ‚Ä¢ Luxury: 850‚Ç¨\n\nüèúÔ∏è **Sahara Express** (4d)\n‚Ä¢ Standard: 280‚Ç¨ ‚Ä¢ Luxury: 480‚Ç¨\n\nüèîÔ∏è **Atlas Discovery** (5d)\n‚Ä¢ Standard: 320‚Ç¨ ‚Ä¢ Luxury: 520‚Ç¨\n\nüåä **Coastal Tour** (6d)\n‚Ä¢ Standard: 380‚Ç¨ ‚Ä¢ Luxury: 680‚Ç¨\n\n*Includes: accommodation, transport, guides, meals*"
            : "üí∞ **Precios 2024 - Tours Premium**\n\nüèõÔ∏è **Circuito Imperial** (7d)\n‚Ä¢ Est√°ndar: 450‚Ç¨ ‚Ä¢ Lujo: 850‚Ç¨\n\nüèúÔ∏è **S√°hara Express** (4d)\n‚Ä¢ Est√°ndar: 280‚Ç¨ ‚Ä¢ Lujo: 480‚Ç¨\n\nüèîÔ∏è **Descubrimiento del Atlas** (5d)\n‚Ä¢ Est√°ndar: 320‚Ç¨ ‚Ä¢ Lujo: 520‚Ç¨\n\nüåä **Tour Costero** (6d)\n‚Ä¢ Est√°ndar: 380‚Ç¨ ‚Ä¢ Lujo: 680‚Ç¨\n\n*Incluye: alojamiento, transporte, gu√≠as, comidas*";
      return { text: pricingText, type: 'pricing' };
    }

    // R√©ponse par d√©faut intelligente / Default response
    const menuText = language === 'fr'
      ? "Je suis votre experte Maroc ! Posez-moi des questions sur :\n\nüèõÔ∏è **Villes** (histoire, attractions, excursions)\nüéØ **R√©servations** (circuits, h√©bergements)\nüí∞ **Prix** (budgets, comparaisons)\nüõ°Ô∏è **S√©curit√©** (conseils, zones)\nüçΩÔ∏è **Culture** (gastronomie, traditions)\nüì∏ **Activit√©s** (photo, aventure, d√©tente)\n\nQue voulez-vous d√©couvrir ?"
      : language === 'ar'
        ? "ÿ£ŸÜÿß ÿÆÿ®Ÿäÿ±ÿ™ŸÉ ŸÅŸä ÿßŸÑŸÖÿ∫ÿ±ÿ®! ÿßÿ≥ÿ£ŸÑŸÜŸä ÿπŸÜ:\n\nüèõÔ∏è **ÿßŸÑŸÖÿØŸÜ** (ÿßŸÑÿ™ÿßÿ±ŸäÿÆÿå ÿßŸÑŸÖÿπÿßŸÑŸÖÿå ÿßŸÑÿ±ÿ≠ŸÑÿßÿ™)\nüéØ **ÿßŸÑÿ≠ÿ¨Ÿàÿ≤ÿßÿ™** (ÿßŸÑÿ¨ŸàŸÑÿßÿ™ÿå ÿßŸÑÿ•ŸÇÿßŸÖÿ©)\nüí∞ **ÿßŸÑÿ£ÿ≥ÿπÿßÿ±** (ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿßÿ™ÿå ÿßŸÑŸÖŸÇÿßÿ±ŸÜÿßÿ™)\nüõ°Ô∏è **ÿßŸÑÿ£ŸÖÿßŸÜ** (ÿßŸÑŸÜÿµÿßÿ¶ÿ≠ÿå ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ)\nüçΩÔ∏è **ÿßŸÑÿ´ŸÇÿßŸÅÿ©** (ÿßŸÑŸÖÿ∑ÿ®ÿÆÿå ÿßŸÑÿ™ŸÇÿßŸÑŸäÿØ)\nüì∏ **ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©** (ÿßŸÑÿ™ÿµŸàŸäÿ±ÿå ÿßŸÑŸÖÿ∫ÿßŸÖÿ±ÿ©ÿå ÿßŸÑÿßÿ≥ÿ™ÿ±ÿÆÿßÿ°)\n\nŸÖÿßÿ∞ÿß ÿ™ÿ±ŸäÿØ ÿ£ŸÜ ÿ™ŸÉÿ™ÿ¥ŸÅÿü"
        : language === 'en'
          ? "I'm your Morocco expert! Ask me about:\n\nüèõÔ∏è **Cities** (history, attractions, excursions)\nüéØ **Bookings** (tours, accommodation)\nüí∞ **Prices** (budgets, comparisons)\nüõ°Ô∏è **Safety** (tips, areas)\nüçΩÔ∏è **Culture** (cuisine, traditions)\nüì∏ **Activities** (photo, adventure, relaxation)\n\nWhat would you like to discover?"
          : "¬°Soy tu experta en Marruecos! Preg√∫ntame sobre:\n\nüèõÔ∏è **Ciudades** (historia, atracciones, excursiones)\nüéØ **Reservas** (tours, alojamiento)\nüí∞ **Precios** (presupuestos, comparaciones)\nüõ°Ô∏è **Seguridad** (consejos, zonas)\nüçΩÔ∏è **Cultura** (gastronom√≠a, tradiciones)\nüì∏ **Actividades** (foto, aventura, relajaci√≥n)\n\n¬øQu√© te gustar√≠a descubrir?";
    
    return {
      text: menuText,
      type: 'menu'
    };
  };

  const handleSend = () => {
    if (inputText.trim()) {
      addUserMessage(inputText);
      setInputText('');
    }
  };

  const handleQuickReply = (reply: string) => {
    addUserMessage(reply);
  };

  const quickRepliesMap = {
    fr: [
      "R√©server un circuit",
      "Infos Marrakech",
      "Infos F√®s",
      "Infos Chefchaouen",
      "Infos Essaouira",
      "Infos Casablanca",
      "S√©curit√© au Maroc",
      "Prix et budgets",
      "M√©t√©o Marrakech",
      "Culture & Gastronomie",
      "Recommandations personnalis√©es"
    ],
    ar: [
      "ÿ≠ÿ¨ÿ≤ ÿ¨ŸàŸÑÿ©",
      "ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖÿ±ÿßŸÉÿ¥",
      "ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÅÿßÿ≥",
      "ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ¥ŸÅÿ¥ÿßŸàŸÜ",
      "ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸàŸäÿ±ÿ©",
      "ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿØÿßÿ± ÿßŸÑÿ®Ÿäÿ∂ÿßÿ°",
      "ÿßŸÑÿ≥ŸÑÿßŸÖÿ© ŸÅŸä ÿßŸÑŸÖÿ∫ÿ±ÿ®",
      "ÿßŸÑÿ£ÿ≥ÿπÿßÿ± ŸàÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿßÿ™",
      "ÿ∑ŸÇÿ≥ ŸÖÿ±ÿßŸÉÿ¥",
      "ÿßŸÑÿ´ŸÇÿßŸÅÿ© ŸàÿßŸÑŸÖÿ∑ÿ®ÿÆ",
      "ÿ™ŸàÿµŸäÿßÿ™ ŸÖÿÆÿµÿµÿ©"
    ],
    en: [
      "Book a tour",
      "Marrakech info",
      "Fez info",
      "Chefchaouen info",
      "Essaouira info",
      "Casablanca info",
      "Morocco safety",
      "Prices & budgets",
      "Marrakech weather",
      "Culture & Food",
      "Personalized recommendations"
    ],
    es: [
      "Reservar un tour",
      "Info Marrakech",
      "Info Fez",
      "Info Chefchaouen",
      "Info Essaouira",
      "Info Casablanca",
      "Seguridad en Marruecos",
      "Precios y presupuestos",
      "Clima Marrakech",
      "Cultura y Gastronom√≠a",
      "Recomendaciones personalizadas"
    ]
  } as const;

  const formatTime = (date: Date) => {
    const locale = language === 'fr' ? 'fr-FR' : language === 'ar' ? 'ar-MA' : language === 'en' ? 'en-GB' : 'es-ES';
    return date.toLocaleTimeString(locale, { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  };

  return (
    <>
      {/* Super AI Button */}
      <button
        onClick={() => setIsOpen(true)}
        className={`fixed bottom-4 ${language === 'ar' ? 'left-4' : 'right-4'} z-40 bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 hover:from-purple-700 hover:via-pink-700 hover:to-red-700 text-white p-3 sm:p-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-110 ${
          isOpen ? 'hidden' : 'block'
        }`}
      >
        <Bot className="h-6 w-6" />
        <div className="absolute -top-1 -right-1 w-4 h-4 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full animate-pulse flex items-center justify-center">
          <Sparkles className="h-2 w-2 text-white" />
        </div>
        <div className="absolute -bottom-2 left-1/2 transform -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
          {language === 'fr' ? 'Guide IA Expert' : language === 'ar' ? 'ŸÖÿ±ÿ¥ÿØ ÿ∞ŸÉÿßÿ° ÿßÿµÿ∑ŸÜÿßÿπŸä ÿÆÿ®Ÿäÿ±' : language === 'en' ? 'Expert AI Guide' : 'Gu√≠a IA Experta'}
        </div>
      </button>

      {/* Super AI Chat Window */}
      {isOpen && (
        <div className={`ai-chat fixed bottom-4 ${language === 'ar' ? 'left-4' : 'right-4'} z-50 w-80 sm:w-96 h-[500px] sm:h-[650px] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-gray-200`}>
          {/* Header */}
          <div className="bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 text-white p-4 flex items-center justify-between">
            <div className="flex items-center">
              <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mr-3 backdrop-blur-sm">
                <Bot className="h-6 w-6 text-white" />
              </div>
              <div>
                <h3 className="font-bold text-lg">
                  {language === 'fr' ? 'Aicha - Guide IA Expert' : language === 'ar' ? 'ÿπÿßÿ¶ÿ¥ÿ© - ÿßŸÑŸÖÿ±ÿ¥ÿØ ÿßŸÑÿ∞ŸÉŸä' : language === 'en' ? 'Aicha - Expert AI Guide' : 'Aicha - Gu√≠a IA Experta'}
                </h3>
                <div className="flex items-center gap-2 text-sm">
                  <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                  <Sparkles className="h-3 w-3" />
                  <span>{language === 'fr' ? 'Expert Maroc 24/7' : language === 'ar' ? 'ÿÆÿ®Ÿäÿ± ÿßŸÑŸÖÿ∫ÿ±ÿ® 24/7' : language === 'en' ? 'Morocco expert 24/7' : 'Experta de Marruecos 24/7'}</span>
                </div>
              </div>
            </div>
            <button
              onClick={() => setIsOpen(false)}
              className="hover:bg-white/20 p-2 rounded-lg transition-colors"
            >
              <X className="h-5 w-5" />
            </button>
          </div>

          {/* Messages */}
          <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gradient-to-b from-gray-50 to-white">
            {messages.map((message) => (
              <div
                key={message.id}
                className={`flex ${message.sender === 'user' ? 'justify-end' : 'justify-start'}`}
              >
                <div className={`max-w-xs px-4 py-3 rounded-2xl ${
                  message.sender === 'user'
                    ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                    : 'bg-white text-gray-800 shadow-md border border-gray-100'
                }`}>
                  {message.sender === 'ai' && (
                    <div className="flex items-center gap-2 mb-2">
                      <Bot className="h-4 w-4 text-purple-600" />
                      <span className="text-xs font-medium text-purple-600">
                        {language === 'fr' ? 'Aicha IA Expert' : language === 'ar' ? 'ÿπÿßÿ¶ÿ¥ÿ© ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä' : language === 'en' ? 'Aicha AI Expert' : 'Aicha IA Experta'}
                      </span>
                    </div>
                  )}
                  <p className="text-sm whitespace-pre-line leading-relaxed">{message.text}</p>
                  <p className={`text-xs mt-2 ${
                    message.sender === 'user' ? 'text-purple-100' : 'text-gray-500'
                  }`}>
                    {formatTime(message.timestamp)}
                  </p>
                </div>
              </div>
            ))}

            {/* Typing Indicator */}
            {isTyping && (
              <div className="flex justify-start">
                <div className="bg-white text-gray-800 shadow-md px-4 py-3 rounded-2xl border border-gray-100">
                  <div className="flex items-center gap-2 mb-2">
                    <Bot className="h-4 w-4 text-purple-600" />
                    <span className="text-xs font-medium text-purple-600">
                      {language === 'fr' ? 'Aicha analyse...' : language === 'ar' ? 'ÿπÿßÿ¶ÿ¥ÿ© ÿ™ÿ≠ŸÑŸÑ...' : language === 'en' ? 'Aicha is analyzing...' : 'Aicha est√° analizando...'}
                    </span>
                  </div>
                  <div className="flex items-center gap-1">
                    <div className="flex space-x-1">
                      <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" />
                      <div className="w-2 h-2 bg-pink-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }} />
                      <div className="w-2 h-2 bg-red-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }} />
                    </div>
                  </div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* Quick Replies */}
          {messages.length > 0 && messages.length < 4 && (
            <div className="p-3 bg-gray-50 border-t">
              <div className="flex flex-wrap gap-2">
                {quickRepliesMap[language].slice(0, 3).map((reply: string, index: number) => (
                  <button
                    key={index}
                    onClick={() => handleQuickReply(reply)}
                    className="text-xs bg-white border-2 border-purple-200 text-purple-700 hover:bg-purple-50 hover:border-purple-300 px-3 py-2 rounded-full transition-colors font-medium"
                  >
                    {reply}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Input */}
          <div className="p-4 bg-gray-100 border-t border-gray-200">
            <div className="flex space-x-2">
              <input
                type="text"
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                placeholder={language === 'fr' ? 'Posez votre question d\'expert...' : language === 'ar' ? 'ÿßÿ∑ÿ±ÿ≠ ÿ≥ÿ§ÿßŸÑŸÉ...' : language === 'en' ? 'Ask your expert question...' : 'Haz tu pregunta al experto...'}
                style={{ backgroundColor: 'white', color: 'black', WebkitTextFillColor: 'black', caretColor: 'black', fontSize: '16px', fontWeight: '500' }}
                className="flex-1 px-4 py-3 border-2 border-purple-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent placeholder-gray-500"
              />
              <button
                onClick={handleSend}
                disabled={!inputText.trim()}
                className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 disabled:from-gray-300 disabled:to-gray-400 text-white p-3 rounded-xl transition-all duration-200 transform hover:scale-105 disabled:transform-none"
              >
                <Send className="h-4 w-4" />
              </button>
            </div>
            
            {/* Expert Features */}
            <div className="flex justify-center space-x-4 mt-3 pt-3 border-t border-gray-200">
              <button 
                onClick={() => handleQuickReply(
                  language === 'fr' ? 'R√©server maintenant' : language === 'ar' ? 'ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿ¢ŸÜ' : language === 'en' ? 'Book now' : 'Reservar ahora'
                )}
                className="flex items-center text-xs text-purple-600 hover:text-purple-800 transition-colors font-medium"
              >
                <Calendar className="h-3 w-3 mr-1" />
                {language === 'fr' ? 'R√©server' : language === 'ar' ? 'ÿßÿ≠ÿ¨ÿ≤' : language === 'en' ? 'Book' : 'Reservar'}
              </button>
              <button 
                onClick={() => handleQuickReply(
                  language === 'fr' ? 'Conseils s√©curit√©' : language === 'ar' ? 'ŸÜÿµÿßÿ¶ÿ≠ ÿßŸÑÿ£ŸÖÿßŸÜ' : language === 'en' ? 'Safety tips' : 'Consejos de seguridad'
                )}
                className="flex items-center text-xs text-purple-600 hover:text-purple-800 transition-colors font-medium"
              >
                <Shield className="h-3 w-3 mr-1" />
                {language === 'fr' ? 'S√©curit√©' : language === 'ar' ? 'ÿßŸÑÿ£ŸÖÿßŸÜ' : language === 'en' ? 'Safety' : 'Seguridad'}
              </button>
              <button 
                onClick={() => handleQuickReply(
                  language === 'fr' ? 'Prix d√©taill√©s' : language === 'ar' ? 'ÿßŸÑÿ£ÿ≥ÿπÿßÿ± ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ' : language === 'en' ? 'Detailed prices' : 'Precios detallados'
                )}
                className="flex items-center text-xs text-purple-600 hover:text-purple-800 transition-colors font-medium"
              >
                <CreditCard className="h-3 w-3 mr-1" />
                {language === 'fr' ? 'Prix' : language === 'ar' ? 'ÿßŸÑÿ£ÿ≥ÿπÿßÿ±' : language === 'en' ? 'Prices' : 'Precios'}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}
